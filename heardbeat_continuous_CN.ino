#include "U8glib.h"
#define sampling 11

U8GLIB_SSD1306_128X64 u8g(U8G_I2C_OPT_NONE);

const uint8_t ning[] PROGMEM = {
0x00,0x00,0x00,0x20,0x00,0x00,0x20,0x02,
0x00,0x10,0xFE,0x03,0x10,0x01,0x01,0x98,
0x90,0x00,0x54,0x10,0x00,0x12,0x52,0x00,
0x10,0x91,0x01,0x90,0x10,0x01,0x50,0x1E,
0x01,0x10,0x08,0x00,0x48,0x02,0x00,0x48,
0x84,0x00,0x48,0x44,0x03,0x48,0x40,0x02,
0x4C,0x40,0x02,0xC0,0x7F,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,/*"您",0*/
};
const uint8_t de[] PROGMEM = {
0x00,0x00,0x00,0x20,0x10,0x00,0x20,0x30,
0x00,0x20,0x10,0x00,0x10,0x18,0x00,0xFC,
0xF9,0x03,0x0C,0x09,0x02,0x0C,0x05,0x02,
0x0C,0x03,0x02,0x0C,0x09,0x03,0xFC,0x11,
0x03,0x0C,0x11,0x03,0x0C,0x11,0x03,0x0C,
0x01,0x03,0x0C,0x01,0x01,0x0C,0x01,0x01,
0xFC,0x01,0x01,0x0C,0xE1,0x01,0x04,0x80,
0x00,0x00,0x00,0x00,/*"的",1*/
};
const uint8_t xin[] PROGMEM = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
0x00,0x00,0x06,0x00,0x00,0x0C,0x00,0xC0,
0x0C,0x00,0xC0,0x08,0x00,0xC0,0x00,0x00,
0xC0,0x80,0x00,0xC8,0x00,0x01,0xC8,0x00,
0x03,0xC8,0x40,0x06,0xCC,0x40,0x02,0xC4,
0x40,0x00,0xC0,0x40,0x00,0xC0,0xC0,0x00,
0x80,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,/*"心",2*/
};
const uint8_t tiao[] PROGMEM = {
0x00,0x00,0x00,0x00,0x48,0x00,0xFC,0x48,
0x00,0x44,0x48,0x00,0x44,0x48,0x02,0x44,
0x49,0x03,0x6C,0xCA,0x00,0x54,0x4A,0x00,
0x10,0x4A,0x00,0x10,0x48,0x00,0xF4,0xCC,
0x01,0x14,0x4B,0x02,0x94,0x49,0x02,0x14,
0x4C,0x00,0x14,0x44,0x00,0x74,0x44,0x02,
0x0E,0x42,0x02,0x00,0xC1,0x07,0xC0,0x00,
0x00,0x00,0x00,0x00,/*"跳",3*/
};
const uint8_t shi[] PROGMEM = {
0x00,0x00,0x00,0xE0,0x7F,0x00,0x40,0x60,
0x00,0x40,0x60,0x00,0xC0,0x7F,0x00,0x40,
0x60,0x00,0x40,0x60,0x00,0xC0,0x7F,0x00,
0x60,0x20,0x00,0xDC,0xFB,0x03,0x20,0x04,
0x00,0x60,0x04,0x00,0x20,0x04,0x00,0x20,
0xFC,0x01,0x70,0x04,0x00,0x90,0x04,0x00,
0x08,0x07,0x00,0x04,0xFE,0x07,0x02,0xE0,
0x03,0x00,0x00,0x00,/*"是",4*/
};
const uint8_t mei[] PROGMEM = {
0x00,0x00,0x00,0x40,0x00,0x00,0x60,0x00,
0x01,0xE0,0xFF,0x03,0x10,0x00,0x00,0x08,
0x00,0x00,0xE8,0xFE,0x00,0x24,0x81,0x00,
0x20,0xC6,0x00,0x20,0xC4,0x00,0xFC,0xFE,
0x07,0x20,0x41,0x00,0x10,0x46,0x00,0x10,
0x44,0x00,0xF0,0xFF,0x03,0x10,0x40,0x00,
0x00,0x40,0x00,0x00,0x70,0x00,0x00,0x20,
0x00,0x00,0x00,0x00,/*"每",5*/
};
const uint8_t feng[] PROGMEM = {
0x00,0x00,0x00,0x00,0x18,0x00,0x80,0x09,
0x00,0xC0,0x10,0x00,0x40,0x10,0x00,0x60,
0x20,0x00,0x20,0x60,0x00,0x10,0xC0,0x00,
0xF8,0xFE,0x03,0x04,0x21,0x03,0x02,0x21,
0x00,0x00,0x21,0x00,0x80,0x20,0x00,0x80,
0x20,0x00,0xC0,0x20,0x00,0x40,0x20,0x00,
0x20,0x20,0x00,0x18,0x1C,0x00,0x04,0x08,
0x00,0x00,0x00,0x00,/*"分",6*/
};
const uint8_t zhong[] PROGMEM = {
0x00,0x00,0x00,0x10,0x20,0x00,0x10,0x20,
0x00,0x18,0x20,0x00,0xF8,0x21,0x00,0x08,
0xFE,0x03,0x04,0x22,0x02,0xEC,0x22,0x02,
0x12,0x22,0x02,0x10,0x22,0x02,0xFC,0xFF,
0x03,0x10,0x22,0x02,0x10,0x20,0x00,0x10,
0x21,0x00,0x90,0x20,0x00,0x70,0x20,0x00,
0x30,0x20,0x00,0x10,0x20,0x00,0x00,0x20,
0x00,0x00,0x00,0x00,/*"钟",7*/
};
const uint8_t ci[] PROGMEM = {
0x00,0x00,0x00,0x00,0x04,0x00,0x04,0x0C,
0x00,0x18,0x04,0x00,0x10,0x04,0x00,0x50,
0xF6,0x03,0x40,0x0A,0x03,0x20,0x11,0x01,
0x20,0x99,0x00,0x90,0x18,0x00,0x50,0x28,
0x00,0x10,0x28,0x00,0x0C,0x28,0x00,0x08,
0x44,0x00,0x08,0x44,0x00,0x08,0x82,0x00,
0x08,0x81,0x01,0xC0,0x00,0x07,0x20,0x00,
0x00,0x00,0x00,0x00,/*"次",8*/
}; 

unsigned long times[sampling];
int head=0;
int vol=0;
boolean condition = false;
boolean sta=false;

void isr() {    
  head=head+1;        
  times[head]=millis();   
  condition=true; 
   timerIsr();  
  if(head == sampling){    
     head=0;         
     times[head]=0;
   }      
}

void setup() {
  Serial.begin(115200);  
  attachInterrupt(0,isr,RISING); //core+ pin2 
  pinMode(13, OUTPUT);  
}


void loop( ){
    
     if(condition){        
     vol=((times[10]-times[9])+(times[9]-times[8])+(times[8]-times[7])+(times[7]-times[6])+(times[6]-times[5])+(times[5]-times[4])+(times[4]-times[3])+(times[3]-times[2])+(times[2]-times[1])+(times[1]-times[0])); 
     int avg = vol/10;
     int heartbeat = 60000/avg;        
   
   if(heartbeat>60 && heartbeat<120){
       u8g.firstPage();            
   do {                
    u8g.drawXBMP( 0, 0, 20, 20, ning); 
    u8g.drawXBMP( 20, 0, 20, 20, de);
    u8g.drawXBMP( 40, 0, 20, 20, xin);
    u8g.drawXBMP( 60, 0, 20, 20, tiao);
    u8g.drawXBMP( 80, 0, 20, 20, shi);  
    u8g.drawXBMP( 100, 0, 20, 20, mei); 
    u8g.drawXBMP( 0, 30, 20, 20, feng); 
    u8g.drawXBMP(20,30, 20, 20, zhong); 
    u8g.setFont(u8g_font_fub20);
    u8g.setPrintPos(52, 50); 
    u8g.print(heartbeat); 
    u8g.drawXBMP(100,30, 20, 20, ci);
     }  while( u8g.nextPage() );                   
     }                                        
    }
  }

void timerIsr()
{ 
    sta=!sta;
    digitalWrite( 13, sta);
}

